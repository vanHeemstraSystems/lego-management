<!doctype html>

<html>

<head>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>LEGO Management (PAUSED)</title>
  <link rel="stylesheet" href="css/PAUSED.style.css">
</head>

<body>
  <div id="canvasContainer" class="canvasContainer">
    <a id="btn_canvas" class="btn_canvas"></a>
  </div>

  <div id="toolContainer" class="toolContainer">

    <div class="rangeContainer color1">
      <a id="btn_RangeA_Minus" class="btn">
        <svg class="icon">
          <use xlink:href="#icon-minus"></use>
        </svg>
      </a>
      <input type="range" id="rangeA" class="range" />
      <a id="btn_RangeA_Plus" class="btn">
        <svg class="icon">
          <use xlink:href="#icon-plus"></use>
        </svg>
      </a>
    </div>

    <div class="rangeContainer color2">
      <a id="btn_RangeB_Minus" class="btn">
        <svg class="icon">
          <use xlink:href="#icon-minus"></use>
        </svg>
      </a>
      <input type="range" id="rangeB" class="range" />
      <a id="btn_RangeB_Plus" class="btn">
        <svg class="icon">
          <use xlink:href="#icon-plus"></use>
        </svg>
      </a>
    </div>

  </div>

  <div class="toolContainer2 color3">
    <a id="btn_Action" class="btn2">
      <svg class="icon">
        <use xlink:href="#icon-file-text2"></use>
      </svg>
    </a>
  </div>

  <div style="position:absolute;top:0;left:0;z-index:100;">
    <textarea id="textarea" rows=5></textarea>
  </div>

  <svg height="0">
    <defs>
      <symbol id="icon-plus" viewBox="0 0 32 32">
        <path
          d="M31 12h-11v-11c0-0.552-0.448-1-1-1h-6c-0.552 0-1 0.448-1 1v11h-11c-0.552 0-1 0.448-1 1v6c0 0.552 0.448 1 1 1h11v11c0 0.552 0.448 1 1 1h6c0.552 0 1-0.448 1-1v-11h11c0.552 0 1-0.448 1-1v-6c0-0.552-0.448-1-1-1z">
        </path>
      </symbol>
      <symbol id="icon-minus" viewBox="0 0 32 32">
        <path d="M0 13v6c0 0.552 0.448 1 1 1h30c0.552 0 1-0.448 1-1v-6c0-0.552-0.448-1-1-1h-30c-0.552 0-1 0.448-1 1z">
        </path>
      </symbol>
      <symbol id="icon-file-text2" viewBox="0 0 32 32">
        <path
          d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z">
        </path>
        <path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
        <path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
        <path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
      </symbol>
    </defs>
  </svg>

  <!--
    <script src="js/spin.js"></script>
    <script src="js/three_r87.min.js"></script>
    <script src="js/three_r87_ColladaLoader_extracted.min.js"></script>
    <script src="js/Tween_r17-1.min.js"></script>
  -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/87/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/17.3.0/Tween.min.js"></script>
  <script src="js/script.js"></script>
  <script src="models/PAUSED.instCSV.js"></script>

  <script>
    window.addEventListener("load", function () {
      var modelPath = 'models/PAUSED.model.dae';
      // var modelPath = 'models/lego-azure.dae';
      var instCSV = MYAPP.instCSV || undefined;

      var canvasContainer = document.getElementById("canvasContainer");

      var spinner = MYAPP.setupSpinner(canvasContainer, '#ffffff');

      var canvas = new MYAPP.Canvas(canvasContainer, {
        backgroundColor: 0x55acfc,
        cameraDistance: 300,
        fov: 80,
        zoomMin: 0.5,
        zoomMax: 3.0,
        initialRotation: [35, 0, 0],
      });

      var light = new THREE.AmbientLight(0xccccff, .2);
      canvas.addLight(light);

      var light2 = new THREE.DirectionalLight(0xffffff, 0.5);
      light2.position.set(-1, 1, 1).normalize();
      canvas.addLight(light2);

      var light3 = new THREE.DirectionalLight(0xffffff, 0.5);
      light3.position.set(1, -1, 1).normalize();
      canvas.addLight(light3);

      var light4 = new THREE.DirectionalLight(0xffffff, 0.5);
      light4.position.set(0, 1, 0.5).normalize();
      canvas.addLight(light4);


      var loader = new THREE.ColladaLoader();
      loader.load(modelPath, function (data) {
        var model = data.scene;
        model.scale.set(1, 1, 1);
        //model.position.set(0,0,0);

        setupInst(model, instCSV);
        setupAction(model);

        canvas.addModel(model);

        spinner.stop();
      });


      function renderLoop() {
        requestAnimationFrame(renderLoop);
        TWEEN.update();
        canvas.render();
      }
      renderLoop();

    }, false)


    function setupInst(model, instCSV) {
      var inst = MYAPP.createInst(model, instCSV);

      var rangeB = document.getElementById("rangeB");
      rangeB.min = inst.getStepMin();
      rangeB.max = inst.getStepMax();
      rangeB.step = inst.getStepStep();
      rangeB.value = inst.getCurStep();
      rangeB.addEventListener("input", function (e) {
        inst.setStep(rangeB.value);
      }, false)


      var inputEvent = new Event("input");

      var stepForward = function (e) {
        e.preventDefault();
        rangeB.value = +rangeB.value + +rangeB.step;
        rangeB.dispatchEvent(inputEvent);
      }

      var stepBackward = function (e) {
        e.preventDefault();
        rangeB.value -= rangeB.step;
        rangeB.dispatchEvent(inputEvent);
      }

      var btn_RangeB_Minus = document.getElementById("btn_RangeB_Minus");
      btn_RangeB_Minus.addEventListener("click", stepBackward, false)
      btn_RangeB_Minus.addEventListener("touchstart", stepBackward, false)

      var btn_RangeB_Plus = document.getElementById("btn_RangeB_Plus");
      btn_RangeB_Plus.addEventListener("click", stepForward, false)
      btn_RangeB_Plus.addEventListener("touchstart", stepForward, false)

      var toolContainer = document.getElementById("toolContainer");

      //prevent pinch-zooming
      toolContainer.addEventListener("touchstart", function (e) {
        if (e.touches.length >= 2) e.preventDefault();
      }, false)

      //prevent tap-zooming
      toolContainer.addEventListener("touchend", function (e) {
        e.preventDefault();
      }, false)


      //complex code...
      //touchend doesn't work well in android...
      var btn_canvas = document.getElementById("btn_canvas");
      var isClick;
      var startX, startY;

      var btn_canvas_touchend = function (e) {
        if (!isClick) { return; }

        isClick = false;

        if (startX > btn_canvas.offsetWidth / 2) {
          stepForward(e);
        } else {
          stepBackward(e);
        }

      }

      var isMoved = function (endX, endY) {
        return Math.abs(endX - startX) > 3 || Math.abs(endY - startY) > 3;
      }

      btn_canvas.addEventListener("touchstart", function (e) {
        isClick = true;
        startX = e.touches[0].pageX;
        startY = e.touches[0].pageY;
      }, false)
      btn_canvas.addEventListener("mousedown", function (e) {
        isClick = true;
        startX = e.pageX;
        startY = e.pageY;
      }, false)
      btn_canvas.addEventListener("touchmove", function (e) {
        if (isMoved(e.touches[0].pageX, e.touches[0].pageY)) {
          isClick = false;
        }
      }, false)
      btn_canvas.addEventListener("mousemove", function (e) {
        if (isMoved(e.pageX, e.pageY)) {
          isClick = false;
        }
      }, false)
      btn_canvas.addEventListener("touchend", btn_canvas_touchend, false)
      btn_canvas.addEventListener("mouseup", btn_canvas_touchend, false)

    }


    function setupAction(model) {
      var c0 = model.getObjectByName("c0");
      var c1 = model.getObjectByName("c1");
      var c2 = model.getObjectByName("c2");
      var c4 = model.getObjectByName("c4");
      var c_1 = model.getObjectByName("c_1");
      var c_2 = model.getObjectByName("c_2");
      var c_4 = model.getObjectByName("c_4");
      var r2 = model.getObjectByName("r2");
      var r4 = model.getObjectByName("r4");
      var r_2 = model.getObjectByName("r_2");
      var r_4 = model.getObjectByName("r_4");

      var motion = {
        clockMin: -1,
        clockMax: 1,
        clockStep: .01,
        curClock: 0,
        setClock: function (clock) {
          var clock = clock || 0;
          var a = Math.PI * clock * -.34;
          c0.rotation.set(0, a, 0);
          c1.rotation.set(0, a, 0);
          c2.rotation.set(0, a, 0);
          c4.rotation.set(0, a, 0);
          c_1.rotation.set(0, a, 0);
          c_2.rotation.set(0, a, 0);
          c_4.rotation.set(0, a, 0);
          r2.rotation.set(0, -a, 0);
          r4.rotation.set(0, -a, 0);
          r_2.rotation.set(0, -a, 0);
          r_4.rotation.set(0, -a, 0);
          model.rotation.set(0, -a / 2, 0);
          this.curClock = clock;
        },
      }

      var rangeA = document.getElementById("rangeA");
      rangeA.min = motion.clockMin;
      rangeA.max = motion.clockMax;
      rangeA.step = motion.clockStep;
      rangeA.value = motion.curClock;
      rangeA.addEventListener("input", function (e) {
        motion.setClock(rangeA.value);
      }, false)

      var inputEvent = new Event("input");

      var stepForward = function (e) {
        e.preventDefault();
        var unit = +rangeA.step * 10;
        rangeA.value = (Math.round(+rangeA.value / unit) + 1) * unit;
        rangeA.dispatchEvent(inputEvent);
      }

      var stepBackward = function (e) {
        e.preventDefault();
        var unit = +rangeA.step * 10;
        rangeA.value = (Math.round(+rangeA.value / unit) - 1) * unit;
        rangeA.dispatchEvent(inputEvent);
      }

      var btn_RangeA_Minus = document.getElementById("btn_RangeA_Minus");
      btn_RangeA_Minus.addEventListener("click", stepBackward, false)
      btn_RangeA_Minus.addEventListener("touchstart", stepBackward, false)

      var btn_RangeA_Plus = document.getElementById("btn_RangeA_Plus");
      btn_RangeA_Plus.addEventListener("click", stepForward, false)
      btn_RangeA_Plus.addEventListener("touchstart", stepForward, false)

    }

  </script>

</body>

</html>